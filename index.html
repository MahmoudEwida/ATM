<script>
    // Step 4 handlers (continued)
    document.getElementById('targetInput').addEventListener('input', function() {
        userData.target = this.value.trim();
        checkStep4();
    });

    function checkStep4() {
        if (userData.htfChecks.length > 0 && userData.target) {
            document.getElementById('btn4').disabled = false;
            document.getElementById('btn4').classList.add('enabled');
        } else {
            document.getElementById('btn4').disabled = true;
            document.getElementById('btn4').classList.remove('enabled');
        }
    }

    document.getElementById('btn4').addEventListener('click', () => goToStep(5));

    // Step 5 handlers
    document.querySelectorAll('input[name="ltf-check"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                this.parentElement.classList.add('checked');
                userData.ltfChecks.push(this.value);
            } else {
                this.parentElement.classList.remove('checked');
                userData.ltfChecks = userData.ltfChecks.filter(v => v !== this.value);
            }
            checkStep5();
        });
    });

    function checkStep5() {
        // FVG/IFVG is mandatory
        const hasFVG = userData.ltfChecks.includes('fvg');
        if (hasFVG) {
            document.getElementById('btn5').disabled = false;
            document.getElementById('btn5').classList.add('enabled');
        } else {
            document.getElementById('btn5').disabled = true;
            document.getElementById('btn5').classList.remove('enabled');
        }
    }

    document.getElementById('btn5').addEventListener('click', () => {
        fillSummary();
        goToStep(6);
    });

    // Step 6 Summary
    function fillSummary() {
        document.getElementById('summaryBias').textContent =
            formatBias(userData.bias);
        document.getElementById('summaryLiquidity').textContent =
            userData.liquidity?.toUpperCase() || '-';
        document.getElementById('summaryDirection').textContent =
            userData.direction ? userData.direction.toUpperCase() : '-';
        document.getElementById('summaryManipulation').textContent =
            userData.manipulation?.toUpperCase() || '-';
        document.getElementById('summaryFlow').textContent =
            formatFlow(userData.orderFlow);
        document.getElementById('summaryTarget').textContent =
            userData.target || '-';

        // Mark checklist items complete
        markChecklist();
    }

    function formatBias(bias) {
        switch (bias) {
            case 'hunt': return 'HUNT LIQUIDITY';
            case 'inefficiency': return 'REBALANCE INEFFICIENCY';
            case 'equilibrium': return 'REBALANCE EQUILIBRIUM';
            case 'generating': return 'GENERATING LIQUIDITY';
            default: return '-';
        }
    }

    function formatFlow(flow) {
        switch (flow) {
            case 'hh': return 'Higher Highs (HH)';
            case 'll': return 'Lower Lows (LL)';
            case 'neutral': return 'Neutral/Ranging';
            default: return '-';
        }
    }

    function markChecklist() {
        // Step 1
        if (userData.bias && userData.liquidity) document.getElementById('check1').classList.add('complete');
        // Step 2
        if (userData.manipulation === 'yes') document.getElementById('check2').classList.add('complete');
        // Step 3
        if (userData.orderFlow) document.getElementById('check3').classList.add('complete');
        // Step 4
        if (userData.htfChecks.length > 0 && userData.target) document.getElementById('check4').classList.add('complete');
        // Step 5 - MSS confirmed
        if (userData.ltfChecks.includes('mss')) document.getElementById('check5').classList.add('complete');
        // Step 5 - FVG mandatory
        if (userData.ltfChecks.includes('fvg')) document.getElementById('check6').classList.add('complete');
    }

    // Navigation between steps
    function goToStep(step) {
        document.getElementById(`step${currentStep}`).classList.remove('active');
        document.getElementById(`dot${currentStep}`).classList.remove('active');

        currentStep = step;

        document.getElementById(`step${currentStep}`).classList.add('active');
        document.getElementById(`dot${currentStep}`).classList.add('active');

        // Mark completed dots
        for (let i = 1; i < currentStep; i++) {
            document.getElementById(`dot${i}`).classList.add('completed');
        }

        // Update progress bar
        const progressPercent = (currentStep / totalSteps) * 100;
        document.getElementById('progressBar').style.width = `${progressPercent}%`;
    }

    // Reset strategy
    function resetStrategy() {
        location.reload();
    }
</script>
